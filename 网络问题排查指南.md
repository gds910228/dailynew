# 网络问题排查指南

## 常见错误及解决方案

### 1. ERR_PROXY_CONNECTION_FAILED 错误

**错误信息**：
```
GET https://cdn.jsdelivr.net/... net::ERR_PROXY_CONNECTION_FAILED
```

**原因**：
- 网络环境限制（公司网络、学校网络等）
- 代理设置问题
- CDN服务被墙

**解决方案**：

#### 方案A：关闭域名校验（开发阶段推荐）
1. 打开微信开发者工具
2. 点击右上角"详情"
3. 找到"本地设置"
4. 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

#### 方案B：配置多个备用域名
小程序后台已配置多个域名作为备用：
- `api.github.com` - GitHub API
- `raw.githubusercontent.com` - GitHub Raw文件
- `cdn.jsdelivr.net` - jsDelivr CDN

代码会自动尝试这些数据源，直到成功为止。

#### 方案C：使用手机热点测试
1. 开启手机热点
2. 电脑连接手机热点
3. 重新编译小程序测试

---

### 2. request 合法域名错误

**错误信息**：
```
https://api.github.com 不在以下 request 合法域名列表中
```

**解决方案**：

#### 添加域名到小程序后台白名单
1. 登录[微信公众平台](https://mp.weixin.qq.com)
2. 进入"开发" → "开发管理" → "开发设置"
3. 找到"服务器域名"
4. 在"request合法域名"中添加：
   - `https://api.github.com`
   - `https://raw.githubusercontent.com`
   - `https://cdn.jsdelivr.net`

**注意事项**：
- 每月只能修改5次域名配置
- 需要配置HTTPS域名
- 域名必须经过ICP备案

---

### 3. 404 Not Found 错误

**错误信息**：
```
GET https://raw.githubusercontent.com/... 404
```

**原因**：
- GitHub文件还未同步到CDN
- 文件路径错误
- 仓库中没有该文件

**解决方案**：

#### 检查文件是否存在
1. 访问 `https://github.com/gds910228/dailynew/blob/main/data/articles.json`
2. 如果能正常访问，说明文件存在
3. 等待1-2分钟让GitHub同步到CDN

#### 使用GitHub API替代
GitHub API通常更稳定，代码已配置为优先使用API。

---

### 4. 数据格式错误

**错误信息**：
```
解析JSON失败
```

**原因**：
- Base64解码失败
- JSON格式错误
- 编码问题

**解决方案**：

#### 检查数据文件
1. 打开 `data/articles.json`
2. 使用JSON验证工具检查格式：[jsonlint.com](https://jsonlint.com)
3. 确保文件编码为UTF-8

#### 重新生成数据
1. 使用Web后台重新提交文章
2. 检查 `admin/config.js` 配置是否正确
3. 查看浏览器Console日志

---

### 5. 完全无法加载任何数据

**排查步骤**：

#### 步骤1：检查网络连接
```bash
# 测试GitHub连接
ping github.com

# 测试API访问
curl https://api.github.com/repos/gds910228/dailynew/contents/data/articles.json
```

#### 步骤2：查看Console日志
1. 微信开发者工具 → Console标签
2. 查看详细错误信息
3. 注意Console中的提示：`尝试加载源 1/3: ...`

#### 步骤3：使用浏览器测试
1. 复制数据URL到浏览器
2. 测试以下URL：
   - `https://api.github.com/repos/gds910228/dailynew/contents/data/articles.json`
   - `https://raw.githubusercontent.com/gds910228/dailynew/main/data/articles.json`
   - `https://cdn.jsdelivr.net/gh/gds910228/dailynew@main/data/articles.json`

#### 步骤4：检查微信开发者工具设置
- 确认已关闭域名校验（开发阶段）
- 检查网络连接
- 尝试重启微信开发者工具

---

## 开发阶段建议配置

### 微信开发者工具设置
```
✅ 不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书
✅ 启用调试
✅ 启用ES6转ES5
✅ 启用增强编译
```

### 小程序后台域名配置（生产环境）
```
request合法域名：
✅ https://api.github.com
✅ https://raw.githubusercontent.com
✅ https://cdn.jsdelivr.net
```

---

## 代码自动重试机制

代码已实现多URL自动重试：

```javascript
// utils/api.js
dataUrls: [
  'https://api.github.com/...',  // 方案1
  'https://raw.githubusercontent.com/...',  // 方案2
  'https://cdn.jsdelivr.net/...'  // 方案3
]
```

**工作流程**：
1. 优先尝试GitHub API（最稳定）
2. 失败后自动尝试Raw GitHub
3. 再失败尝试jsDelivr CDN
4. 全部失败显示错误提示

**Console日志示例**：
```
尝试加载源 1/3: https://api.github.com/...
数据源 1 请求失败: request:fail
尝试加载源 2/3: https://raw.githubusercontent.com/...
✓ 数据源 2 加载成功
```

---

## 仍然无法解决？

### 收集诊断信息

1. **Console日志**（完整复制）
2. **网络信息**：
   - 所在网络（公司/学校/家庭）
   - 是否使用VPN
   - 网络速度测试结果

3. **测试结果**：
   ```bash
   # 在命令行执行
   curl -I https://api.github.com
   curl -I https://raw.githubusercontent.com
   curl -I https://cdn.jsdelivr.net
   ```

4. **截图**：
   - 微信开发者工具Console
   - 网络面板（Network）
   - 错误提示弹窗

### 备用方案

如果GitHub服务持续不可用，可以考虑：

#### 方案A：使用Gitee（国内）
- 将代码迁移到Gitee
- 修改 `utils/api.js` 中的数据URL
- 修改 `admin/config.js` 中的仓库配置

#### 方案B：使用云开发
- 腾讯云开发（免费额度）
- 阿里云Serverless
- 微信云开发（有免费额度）

---

## 常用测试命令

```bash
# 测试GitHub API
curl -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/gds910228/dailynew/contents/data/articles.json

# 测试Raw GitHub
curl https://raw.githubusercontent.com/gds910228/dailynew/main/data/articles.json

# 测试jsDelivr CDN
curl https://cdn.jsdelivr.net/gh/gds910228/dailynew@main/data/articles.json

# 查看DNS解析
nslookup api.github.com
nslookup raw.githubusercontent.com
nslookup cdn.jsdelivr.net
```

---

## 快速检查清单

- [ ] 微信开发者工具已关闭域名校验
- [ ] 网络连接正常
- [ ] Console中有"尝试加载源"日志
- [ ] 数据文件在GitHub仓库中存在
- [ ] JSON格式正确（可用jsonlint验证）
- [ ] 编码为UTF-8
- [ ] 已尝试下拉刷新
- [ ] 已重启微信开发者工具
- [ ] 浏览器能访问数据URL
- [ ] 不在公司/学校受限网络

---

**最后更新**: 2026-01-19
**相关文档**: 快速入门.md、每日维护指南.md
